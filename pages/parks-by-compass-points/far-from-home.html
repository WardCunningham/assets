<div id=result>working</div>
<script type=module>

  const home = {lat:45.4701282, lon:-122.7462476}
  const site = `http://found.ward.fed.wiki`
  const slug = `places-winter-25`
  const page = await fetch(`${site}/${slug}.json`).then(res => res.json())
  const items = page.story
    .filter(item => ['pagefold','map'].includes(item.type))
  const actions = page.journal
    .filter(action => action.type == 'edit' && action.item.type == 'map')
    .filter(action => action.item.text.split(/\n/).length > 1)
  const quads = ['north','south','east','west']
  const rows = []
  let row = {}

  const list = actions
    .map(action => {
      const when = new Date(action.date)
      const date = when.toLocaleDateString().slice(0,-5)
      const month = date.split(/\//)[0]
      const day = when.toLocaleString(window.navigator.language, {weekday: 'short'})
      const fold = items[items.findIndex(item => item.id == action.id)-1].text
      const coord = action.item.text.split(/\n/).pop()
      if(occupied(fold)) {rows.push(row); row = {}}
      row[fold] = {day,date,month,coord}
      return `${day} ${date} ⇒ ${dist(coord)} ${fold}`
    })
    .join("<br>")
    rows.push(row)

  const table = `
    <table style="border-collapse: collapse;">
      ${`<tr>${quads.map(quad => `<th  style="text-align: center">
        ${quad}`).join("")}`}
      ${rows.map((row, r) =>
        `<tr>${quads.map((quad, c) => format(row[quad],r,c)).join("")}`
      ).join("")}
    </table>`

  window.result.innerHTML = `
    ${table}
    <br>
    <details><summary>data</summary>
      ${list}
    </details>
  `

  function format(item, r, c) {
    let style = `border: 1px solid black; padding: 6px; `
    if (item) {
      const {day,date,month,coord} = item
      if(diff(month,r-1,c)) style += "border-top:2.5px solid black; "
      if(diff(month,r,c-1)) style += "border-left:2.5px solid black; "
      const title = `${bearing(coord)} on ${date}`
      const field = `${day} ⇒ ${dist(coord)}`
      return `<td title="${title}" style="${style}">${field}`
    }
    return `<td style="${style}">`
  }

  function diff(month, r, c) {
    if (r<0 || c<0) return false
    if (!(quads[c] in rows[r])) return false
    return month != rows[r][quads[c]].month
  }

  function dist(coord) {
    const [lat,lon] = coord.split(/,/)
    const dx = Math.abs(home.lon - lon) * 49
    const dy = Math.abs(home.lat - lat) * 69
    return (2*(dx+dy)).toFixed(2)
  }

  function bearing(coord) {
    const [lat,lon] = coord.split(/,/)

    const φ1 = home.lat * Math.PI / 180;
    const φ2 = lat * Math.PI / 180;
    const Δλ = (lon - home.lon) * Math.PI / 180;

    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
    const θ = Math.atan2(y, x); // Radians

    const brng = (θ * 180 / Math.PI + 360) % 360;
    return `${Math.round(brng)}°`;
  }

  function occupied(fold) {
    const wants = quads.slice(quads.indexOf(fold))
    for(const want of wants)
      if(want in row) return true
    return false
  }

</script>