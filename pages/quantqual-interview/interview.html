<div id=result></div>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  import * as index from 'http://code.fed.wiki/assets/v1/index.js'
  const asSlug = title => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
  const asId = string => string.replaceAll(/[^A-Za-z]/g,'_')
  const delay = time => new Promise(res => setTimeout(res,time));
  const context = await frame.context()
  const item = context.page.story.find(item => item.type == 'frame' && item.id == context.itemId)

  let transcript = []
  let path = []
  let asks
  window.result.addEventListener('submit', next)  

  if(item?.path) {
    for(const place of item.path) {
      path.push(place)
      await recall()
    }
  } else {
    path.push({site:context.site,title:context.title,step:0})
    present()
  }

  async function present() {
    const here = path.length - 1
    const place = path[here]
    const url = `${place.site}/${asSlug(place.title)}.json`
    const think = delay(600) // start thinking
    const page = await fetch(`//${url}`).then(res => res.ok? res.json() : null)
    await think
    if (!page) {
      frame.link({site:place.site,title:place.title},false)
      return done(`can't find "${place.title}"`)
    }
    const folds = index.folds(page.story)
    if('interview' in folds) return done('"interview" is now "questions"')
    if(!('questions' in folds)) {
      frame.link({site:place.site,title:place.title},false)
      return done(`can't find "questions" here`)
    }
    asks = folds.questions
      .filter(item => item.type == 'markdown')
      .map(item => parse(item.text))
    if(place.step >= asks.length)
      return done()
    const ask = asks[place.step]
    place.ask = ask
    console.log('present', place)
    if(ask.summary == 'jump') {
      const next = jump(place,ask.details)
      path.push(next)
      console.log('jump',path)
      return present()
    }
    const elem = document.createElement('div')
    elem.id = here
    elem.innerHTML = `
      <details open name=interview>
        <summary>
          ${ask.summary}<br>
          <span style="color:#666"></span>
        </summary>
      <div class="content">
        <hr>
        <form data-here="${here}">
          ${ask.details}
          ${inputs(ask.choices)}
          <center><button>why</button> <button>next</button></center>
        </form>
        <hr>
      </div>
      </details>`
    window.result.append(elem)
  }

  async function recall() {
    const here = path.length - 1
    const place = path[here]
    const ask = place.ask
    if(!ask) return done()
    const elem = document.createElement('div')
    elem.id = here
    elem.innerHTML = `
      <details open name=interview>
        <summary>
          ${ask.summary}<br>
          <span style="color:#666">${place.report}</span>
        </summary>
      <div class="content">
        <hr>
        <form data-here="${here}">
          ${ask.details}
          ${inputs(ask.choices,place)}
          <center><button>why</button> <button>next</button></center>
        </form>
        <hr>
      </div>
      </details>`
    window.result.append(elem)
  }

  function parse(text) {
    const lines = text.trim().split(/\n+/)
    const summary = lines.shift()
    let m
    if(m = summary.match(/^(=>|⇒) *(.*)$/))
      return {summary:'jump',details:m[2],choices:[]}
    const details = lines.shift()
    const choices = []
    while (lines.length && lines[0].startsWith("-")) {
      const [option, _, choice] = lines.shift().replace(/- */,'').split(/ *(⇒|=>) */)
      choices.push({option,choice})
    }
    return {summary,details,choices}
  }

  function inputs(choices,place={}) {
    if(choices.length) {
      return choices.map(each => `<br>
          <input type=radio id="${asId(each.option)}" name="choice"
            ${each.option==place.report ? 'checked' : ''}/>
          <label for="${asId(each.option)}">${each.option}</label>
      `).join("\n")
    } else {
      return `<br>
          <textarea style="width:100%; height:160px;">${place.value??''}</textarea>`
    }
  }

  function next(event) {
    event.preventDefault()
    const form = event.target
    const button = event.submitter.innerText
    const here = form.dataset.here
    const place = path[here]
    if (button=='why') {
      return frame.link({site:place.site,title:place.title},false)
    }
    let report
    let next = {site:place.site,title:place.title,step:place.step+1}
    if (!place.ask.choices.length) {
      place.value = form[0].value
      const words = form[0].value.matchAll(/[A-Za-z]+/g)
      if(words) {
        report = [...words].slice(0,4).join(" ")
        place.report = report
      }
    } else {
      const answers = [...form].filter(elem => elem.type == 'radio')
      for (let i=0; i<answers.length; i++) {
        const ask = place.ask.choices[i]
        if(answers[i].checked) {
          report = ask.option
          place.report = report
          if(ask.choice) {

            const link = ask.choice.match(/\[\[(.*?)\]\]/)
            if(link) {
              next = {site:place.site,title:link[1],step:0}
            } else {
              console.log('local',{asks,ask})
              const step = asks.findIndex(each => each.summary == ask.choice)
              if(step >= 0){
                next = {site:place.site,title:place.title,step}
              } else {
                return done(`can't find "${ask.choice}" here`)
              }
            }

          }
        }
      }
    }
    if (report) {
      erase(here)
      const details = form.closest('details')
      details.querySelector('span').innerText = report
      details.open = false
      path.push(next)
      present()
    }
  }

  function jump(place,choice) {
    const link = choice.match(/\[\[(.*?)\]\]/)
    if(link) {
      return {site:place.site,title:link[1],step:0}
    } else {
      const step = asks.findIndex(each => each.summary == choice)
      if(step >= 0){
        return {site:place.site,title:place.title,step}
      } else {
        done(`can't find "${choice}" here`)
        return null
      }
    }
    return next
  }

  function erase(here) {
    const divs = [...window.result.children].reverse()
    while(Number(divs[0].id) > here) divs.shift().remove()
  }

  function done(message="thank you") {
    const elem = document.createElement('div')
    elem.id = path.length
    elem.innerHTML = `<center>done, ${message}<br><button>save</button></center>`
    elem.querySelector('button').addEventListener('click',event => {
      const title = `Saved ${context.title}`
      const text = `Saved interview from [[${context.title}]].`
      const item = context.page.story.find(item => item.type == 'frame')
      item.path = path
      const story = [{type:'paragraph',text},item]
      frame.open({title,story},event.shiftKey)
    })
    window.result.append(elem)
  }

</script>