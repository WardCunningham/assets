<div id=result></div>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  import * as index from 'http://code.fed.wiki/assets/v1/index.js'
  // import {Accordion} from './accordion.js'
  const asSlug = title => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
  const asId = string => string.replaceAll(/[^A-Za-z]/g,'_')
  const context = await frame.context()

  let transcript = []
  let path = [{site:context.site,title:context.title,step:0}]
  window.result.addEventListener('submit', next)  
  present()

  async function present() {
    const here = path.length - 1
    const place = path[here]
    const url = `${place.site}/${asSlug(place.title)}.json`
    const page = await fetch(`//${url}`).then(res => res.ok? res.json() : null)
    if (!page) {
      frame.link({site:place.site,title:place.title},false)
      return done(`can't find "${place.title}"`)
    }
    const folds = index.folds(page.story)
    if(!('interview' in folds)) {
      frame.link({site:place.site,title:place.title},false)
      return done(`can't find "interview" here`)
    }
    let asks = folds.interview
      .filter(item => item.type == 'markdown')
      .map(item => parse(item.text))
    if(place.step >= asks.length)
      return done()
    const ask = asks[place.step]
    place.ask = ask
    const elem = document.createElement('div')
    elem.id = here
    elem.innerHTML = `
      <details open name=interview>
        <summary>
          ${ask.summary}
          <span style="color:#666"></span>
        </summary>
      <div class="content">
        <hr>
        <form data-here="${here}">
          ${ask.details}
          ${inputs(ask.summary,ask.choices)}
          <center><button>why</button> <button>next</button></center>
        </form>
        <hr>
      </div>
      </details>`
    // new Accordion(elem)
    window.result.append(elem)
  }
  
  function parse(text) {
    const lines = text.trim().split(/\n+/)
    const summary = lines.shift()
    const details = lines.shift()
    const choices = []
    while (lines.length && lines[0].startsWith("-")) {
      const [option, choice] = lines.shift().replace(/- */,'').split(/ *â‡’ */)
      choices.push({option,choice})
    }
    return {summary,details,choices}
  }

  function inputs(summary,choices) {
    if(choices.length) {
      return choices.map(each => `<br>
          <input type=radio id="${asId(each.option)}" name="choice" />
          <label for="${asId(each.option)}">${each.option}</label>
      `).join("\n")
    } else {
      return `<br>
          <textarea style="width:100%; height:160px;"></textarea>`
    }
  }

  function next(event) {
    event.preventDefault()
    const form = event.target
    const button = event.submitter.innerText
    const here = form.dataset.here
    const place = path[here]
    if (button=='why') {
      return frame.link({site:place.site,title:place.title},false)
    }
    let report
    let next = {site:place.site,title:place.title,step:place.step+1}
    if (!place.ask.choices.length) {
      const words = form[0].value.matchAll(/[A-Za-z]+/g)
      if(words) report = [...words].slice(0,4).join(" ")
    } else {
      const answers = [...form].filter(elem => elem.type == 'radio')
      for (let i=0; i<answers.length; i++) {
        const ask = place.ask.choices[i]
        if(answers[i].checked) {
          report = ask.option
          const link = ask.choice.match(/\[\[(.*?)\]\]/)
          if(link) next = {site:place.site,title:link[1],step:0}
        }
      }
    }
    if (report) {
      erase(here)
      const details = form.closest('details')
      details.querySelector('span').innerText = report
      details.open = false
      path.push(next)
      present()
    }
  }

  function erase(here) {
    const divs = [...window.result.children].reverse()
    while(Number(divs[0].id) > here) divs.shift().remove()
  }

  function done(message="thank you") {
    const elem = document.createElement('div')
    elem.id = path.length
    elem.innerHTML = `<center>done, ${message}</center>`
    window.result.append(elem)
  }
</script>