<div id=result>working</div>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  const context = await frame.context()
  const origin = context.origin
  const sitemap = await fetch(`${origin}/system/sitemap.json`).then(res => res.json())
  window.result.innerHTML = `
    <pre></pre>
    <button>start</button>
  `
  let start = 0
  const button = window.result.querySelector('button')
  const result = window.result.querySelector('pre')
  button.addEventListener('click',e => more())

  async function more() {
    button.disabled = true
    const todo = sitemap.slice(start,start+=100)
    await scan(todo)
    button.innerText = `more of ${Math.max(sitemap.length-start,0)}`
    button.disabled = false
  }

  async function scan(todo) {
    return Promise.all(
      todo.map(async info => {
        await fetch(`${origin}/${info.slug}.json`)
          .then(res => res.json())
          .then(page => check(info,page))
      })
    )
  }

  // jq '.journal|group_by(.id)|.[]|select(any(.type=="remove") and any(.item.type=="assets"))

  function check(info,page) {
    const groups = Object.groupBy(page.journal, action => action.id)
    const wanted = Object.entries(groups).filter(([id,actions]) =>
      actions.some(action => action.type == "remove") &&
      actions.some(action => action.item?.type == "assets"))
    if(wanted.length>0) {
      result.innerHTML += `${info.title}\n`
      wanted.forEach(([id,actions]) => {
        result.innerHTML += `  ${id} ${actions
          .map(action => `<span title="${JSON.stringify(action,null,2).replaceAll(/"/g,"'")}">${action.type}</span>`)
          .join(" ")}\n`
      })
    }
  }

</script>